<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Lab 1 | Matias Villalba </title> <meta name="author" content="Matias Villalba"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mvillalbao.github.io/projects/1_project/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Matias</span> Villalba </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Lab 1</h1> <p class="post-description"></p> </header> <article> <h1 id="workgroup---group-3">Workgroup - group 3\</h1> <h2 id="math-demonstrations"> <strong>Math Demonstrations</strong>\</h2> <h3 id="1-prove-the-frisch-waugh-lovell-theorem">1. Prove the Frisch-Waugh-Lovell theorem\</h3> <p>Given the model:</p> \[\begin{align} y &amp;= D \beta_1 + W \beta_2 + \mu \end{align}\] <p>where \(y\) is an \(n \times 1\) vector, \(D\) is an \(n \times k_1\) matrix, \(\beta_1\) is a \(k_1 \times 1\) vector, \(W\) is an \(n \times k_2\) matrix, \(\beta_2\) is a \(k_2 \times 1\) vector, and \(\mu\) is an \(n \times 1\) vector of error terms.</p> <p>We can construct the following equation:</p> \[\begin{align} \epsilon_y &amp;= \epsilon_D \phi + \xi \end{align}\] <p>Running \(y\) on \(W\), we get:</p> \[\begin{align} y &amp;= W\hat{\alpha}_1 + \epsilon_y \iff \epsilon_y &amp;= y - W\hat{\alpha}_1 \end{align}\] <p>Similarly, running \(D\) on \(W\) gives us:</p> \[\begin{align} D &amp;= W\hat{\alpha}_2 + \epsilon_D \iff \epsilon_D &amp;= D - W\hat{\alpha}_2 \end{align}\] <p>Running \(\epsilon_y\) on \(\epsilon_D\):</p> \[\begin{align} y - W \hat{\alpha}_1 &amp;= (D - W \hat{\alpha}_2) \phi + \xi \\ y &amp;= W \hat{\alpha}_1 + (D - W \hat{\alpha}_2) \phi + \xi \\ y &amp;= W \hat{\alpha}_1 + D \phi - W \hat{\alpha}_2 \phi + \xi \\ y &amp;= D \phi + W (\hat{\alpha}_1 - \hat{\alpha}_2 \phi) + \xi \end{align}\] <p>Comparing the original model with this, we can see that: \(\begin{align} \beta_1 &amp;= \phi \\ \beta_2 &amp;= \hat{\alpha}_1 - \hat{\alpha}_2 \phi \\ \mu &amp;= \xi \end{align}\)</p> <h3 id="2-show-that-the-conditional-expectation-function-minimizes-expected-squared-error">2. Show that the Conditional Expectation Function minimizes expected squared error</h3> <p>Given the model: \(\begin{align} Y &amp;= m(X) + e \end{align}\) where \(m(X)\) represents the conditional expectation of \(Y\) on \(X\). Let’s define an arbitrary model: \(\begin{align} Y &amp;= g(X) + w \end{align}\) where \(g(X)\) represents any function of \(X\).</p> <p>Working with the expected squared error from the arbitrary model: \(\begin{align} E[(Y-g(X))^2] &amp;= E[(Y-m(X) + m(X)-g(X))^2] \\ &amp;= E[(Y-m(X))^2 + 2(Y-m(X))(m(X)-g(X)) + (m(X)-g(X))^2] \\ &amp;= E[e^2] + 2E[(Y-m(X))(m(X)-g(X))] + E[(m(X)-g(X))^2] \end{align}\) Using the law of iterated expectations: \(\begin{align} E[(Y-g(X))^2] &amp;= E[e^2] + 2E[E[(Y-m(X))(m(X)-g(X)) | X]] + E[(m(X)-g(X))^2] \end{align}\) Since \(m(X)\) and \(g(X)\) are functions of \(X\), the term \((m(X)-g(X))\) can be thought of as constant when conditioning on \(X\). Thus: \(\begin{align} E[(Y-g(X))^2] &amp;= E[e^2] + 2E[E[Y-m(X) | X](m(X)-g(X))] + E[(m(X)-g(X))^2] \end{align}\) It is important to note that \(E[Y-m(X) | X] = 0\) by definition of \(m(X)\), so we get: \(\begin{align} E[(Y-g(X))^2] &amp;= E[e^2] + E[(m(X)-g(X))^2] \end{align}\) Because the second term in the equation is always non-negative, it is clear that the function is minimized when \(g(X)\) equals \(m(X)\). In which case: \(\begin{align} E[(Y-g(X))^2] &amp;= E[e^2] \end{align}\)</p> <h2 id="replication-1---code"><strong>Replication 1 - Code</strong></h2> <p>In the previous lab, we already analyzed data from the March Supplement of the U.S. Current Population Survey (2015) and answered the question how to use job-relevant characteristics, such as education and experience, to best predict wages. Now, we focus on the following inference question:</p> <p>What is the difference in predicted wages between men and women with the same job-relevant characteristics?</p> <p>Thus, we analyze if there is a difference in the payment of men and women (<em>gender wage gap</em>). The gender wage gap may partly reflect <em>discrimination</em> against women in the labor market or may partly reflect a <em>selection effect</em>, namely that women are relatively more likely to take on occupations that pay somewhat less (for example, school teaching).</p> <p>To investigate the gender wage gap, we consider the following log-linear regression model</p> \[\begin{align} \log(Y) &amp;= \beta'X + \epsilon\\ &amp;= \beta_1 D + \beta_2' W + \epsilon, \end{align}\] <p>where \(D\) is the indicator of being female (\(1\) if female and \(0\) otherwise) and the \(W\)’s are controls explaining variation in wages. Considering transformed wages by the logarithm, we are analyzing the relative difference in the payment of men and women.</p> <h3 id="data-analysis">Data analysis</h3> <p>We consider the same subsample of the U.S. Current Population Survey (2015) as in the previous lab. Let us load the data set.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pyreadr</span> <span class="k">as</span> <span class="n">rr</span> <span class="c1"># package to use data form R format
</span><span class="kn">import</span> <span class="n">math</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!pip install pyreadr==0.4.2
</span></code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rdata_read</span> <span class="o">=</span> <span class="n">rr</span><span class="p">.</span><span class="nf">read_r</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">../../data/wage2015_subsample_inference.Rdata</span><span class="sh">"</span><span class="p">)</span>


<span class="c1"># Extracting the data frame from rdata_read
</span><span class="n">data</span> <span class="o">=</span> <span class="n">rdata_read</span><span class="p">[</span> <span class="sh">'</span><span class="s">data</span><span class="sh">'</span> <span class="p">]</span>


<span class="n">data</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(5150, 20)
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 5150 entries, 10 to 32643
Data columns (total 20 columns):
 #   Column  Non-Null Count  Dtype   
---  ------  --------------  -----   
 0   wage    5150 non-null   float64 
 1   lwage   5150 non-null   float64 
 2   sex     5150 non-null   float64 
 3   shs     5150 non-null   float64 
 4   hsg     5150 non-null   float64 
 5   scl     5150 non-null   float64 
 6   clg     5150 non-null   float64 
 7   ad      5150 non-null   float64 
 8   mw      5150 non-null   float64 
 9   so      5150 non-null   float64 
 10  we      5150 non-null   float64 
 11  ne      5150 non-null   float64 
 12  exp1    5150 non-null   float64 
 13  exp2    5150 non-null   float64 
 14  exp3    5150 non-null   float64 
 15  exp4    5150 non-null   float64 
 16  occ     5150 non-null   category
 17  occ2    5150 non-null   category
 18  ind     5150 non-null   category
 19  ind2    5150 non-null   category
dtypes: category(4), float64(16)
memory usage: 736.3+ KB
</code></pre></div></div> <p><strong><em>Variable description</em></strong></p> <ul> <li>occ : occupational classification</li> <li>ind : industry classification</li> <li>lwage : log hourly wage</li> <li>sex : gender (1 female) (0 male)</li> <li>shs : some high school</li> <li>hsg : High school graduated</li> <li>scl : Some College</li> <li>clg: College Graduate</li> <li>ad: Advanced Degree</li> <li>ne: Northeast</li> <li>mw: Midwest</li> <li>so: South</li> <li>we: West</li> <li>exp1: experience</li> </ul> <h3 id="filtering-data-to-focus-on-college-advanced-educated-workers">Filtering data to focus on college-advanced-educated workers</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">scl</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">clg</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">ad</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
</code></pre></div></div> <h3 id="exploratory-data-analysis">Exploratory Data Analysis</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">[[</span><span class="sh">'</span><span class="s">occ</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">occ2</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ind</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ind2</span><span class="sh">'</span><span class="p">]].</span><span class="nf">describe</span><span class="p">()</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>occ</th> <th>occ2</th> <th>ind</th> <th>ind2</th> </tr> </thead> <tbody> <tr> <th>count</th> <td>3774</td> <td>3774</td> <td>3774</td> <td>3774</td> </tr> <tr> <th>unique</th> <td>330</td> <td>22</td> <td>222</td> <td>21</td> </tr> <tr> <th>top</th> <td>4700</td> <td>1</td> <td>7860</td> <td>18</td> </tr> <tr> <th>freq</th> <td>125</td> <td>510</td> <td>220</td> <td>547</td> </tr> </tbody> </table> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>


<span class="n">wage_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">wage</span><span class="sh">'</span><span class="p">])</span>
<span class="n">cumulative_sum</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">cumsum</span><span class="p">(</span><span class="n">wage_sorted</span><span class="p">)</span>
<span class="n">deciles</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">cumulative_sum</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">population_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="n">salary_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">deciles</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">wage</span><span class="sh">'</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>


<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">population_fraction</span><span class="p">,</span> <span class="n">salary_fraction</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>  


<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Lorenz Curve for Higher Education Salaries</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Cumulative fraction of the population</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Cumulative fraction of salaries</span><span class="sh">"</span><span class="p">)</span>


<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_20_0-480.webp 480w,/assets/img/p1_output_20_0-800.webp 800w,/assets/img/p1_output_20_0-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_20_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="sh">"</span><span class="s">whitegrid</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">lightblue</span><span class="sh">'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="sh">'</span><span class="s">density</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Histogram of Salaries with Density Function</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Lwage</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Density</span><span class="sh">'</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_21_0-480.webp 480w,/assets/img/p1_output_21_0-800.webp 800w,/assets/img/p1_output_21_0-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_21_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Calcular las proporciones de sexos
</span><span class="n">proportions</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Crear un data frame para el gráfico
</span><span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">Male</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Female</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">proportion</span><span class="sh">'</span><span class="p">:</span> <span class="n">proportions</span><span class="p">})</span>

<span class="c1"># Obtener el número total de observaciones
</span><span class="n">total_observations</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Graficar las proporciones de sexos
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">],</span> <span class="n">plot_data</span><span class="p">[</span><span class="sh">'</span><span class="s">proportion</span><span class="sh">'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Proportion of Male and Female Individuals with Higher Education</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Sex</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Percentage</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Agregar etiquetas de porcentaje en las barras
</span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">bars</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="p">.</span><span class="nf">get_height</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="n">bar</span><span class="p">.</span><span class="nf">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="p">.</span><span class="nf">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="sh">'</span><span class="s">bottom</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Agregar el número total de observaciones
</span><span class="n">plt</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="sh">'</span><span class="s">proportion</span><span class="sh">'</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">Total observations: </span><span class="si">{</span><span class="n">total_observations</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="sh">'</span><span class="s">bottom</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Male</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Female</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># Use the custom labels for the legend
</span><span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper right</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_22_0-480.webp 480w,/assets/img/p1_output_22_0-800.webp 800w,/assets/img/p1_output_22_0-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_22_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Education_Status</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="sh">'</span><span class="s">Some College</span><span class="sh">'</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">scl</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                                      <span class="nf">else </span><span class="p">(</span><span class="sh">'</span><span class="s">College Graduate</span><span class="sh">'</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">clg</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                                            <span class="k">else</span> <span class="sh">'</span><span class="s">Advanced Degree</span><span class="sh">'</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">edu_freq</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Education_Status</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">edu_freq</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Education_Status</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">]</span>

<span class="n">total_obs</span> <span class="o">=</span> <span class="n">edu_freq</span><span class="p">[</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
<span class="n">edu_freq</span><span class="p">[</span><span class="sh">'</span><span class="s">Percentage</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">edu_freq</span><span class="p">[</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_obs</span> <span class="o">*</span> <span class="mi">100</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">pie</span><span class="p">(</span><span class="n">edu_freq</span><span class="p">[</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">edu_freq</span><span class="p">[</span><span class="sh">'</span><span class="s">Education_Status</span><span class="sh">'</span><span class="p">],</span> <span class="n">autopct</span><span class="o">=</span><span class="sh">'</span><span class="s">%1.1f%%</span><span class="sh">'</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Education Status Distribution</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">edu_freq</span><span class="p">[</span><span class="sh">'</span><span class="s">Education_Status</span><span class="sh">'</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper right</span><span class="sh">'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">Total observations: </span><span class="si">{</span><span class="n">total_obs</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Matias Villalba\AppData\Local\Temp\ipykernel_2932\1836483406.py:4: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  data['Education_Status'] = data.apply(lambda row: 'Some College' if row['scl'] == 1
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_23_1-480.webp 480w,/assets/img/p1_output_23_1-800.webp 800w,/assets/img/p1_output_23_1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_23_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>


<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">exp1</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Distribution of Experience in Individuals with Higher Education</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Experience (exp1)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_24_0-480.webp 480w,/assets/img/p1_output_24_0-800.webp 800w,/assets/img/p1_output_24_0-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_24_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>To start our (causal) analysis, we compare the sample means given gender:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span> <span class="p">[</span><span class="sh">"</span><span class="s">lwage</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sex</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">shs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">hsg</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">scl</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">clg</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ad</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ne</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">mw</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">so</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">we</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">exp1</span><span class="sh">"</span><span class="p">]</span> <span class="p">]</span>

<span class="n">data_female</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span> <span class="sh">'</span><span class="s">sex</span><span class="sh">'</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">]</span>
<span class="n">Z_female</span> <span class="o">=</span> <span class="n">data_female</span><span class="p">[</span> <span class="p">[</span><span class="sh">"</span><span class="s">lwage</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sex</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">shs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">hsg</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">scl</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">clg</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ad</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ne</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">mw</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">so</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">we</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">exp1</span><span class="sh">"</span><span class="p">]</span> <span class="p">]</span>

<span class="n">data_male</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span> <span class="n">data</span><span class="p">[</span> <span class="sh">'</span><span class="s">sex</span><span class="sh">'</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">Z_male</span> <span class="o">=</span> <span class="n">data_male</span><span class="p">[</span> <span class="p">[</span> <span class="sh">"</span><span class="s">lwage</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">sex</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">shs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">hsg</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">scl</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">clg</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ad</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">ne</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">mw</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">so</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">we</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">exp1</span><span class="sh">"</span> <span class="p">]</span> <span class="p">]</span>


<span class="n">table</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<span class="n">table</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">.</span><span class="nf">mean</span><span class="p">().</span><span class="n">values</span>
<span class="n">table</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_male</span><span class="p">.</span><span class="nf">mean</span><span class="p">().</span><span class="n">values</span>
<span class="n">table</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_female</span><span class="p">.</span><span class="nf">mean</span><span class="p">().</span><span class="n">values</span>
<span class="n">table_pandas</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="sh">'</span><span class="s">All</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Men</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Women</span><span class="sh">'</span><span class="p">])</span> <span class="c1"># from table to dataframe
</span><span class="n">table_pandas</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Log Wage</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">Sex</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">Some High School</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">High School Graduate</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">Some College</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">Gollage Graduate</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">Advanced Degree</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Northeast</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">Midwest</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">South</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">West</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">Experience</span><span class="sh">"</span><span class="p">]</span>
<span class="n">table_html</span> <span class="o">=</span> <span class="n">table_pandas</span><span class="p">.</span><span class="nf">to_html</span><span class="p">()</span> <span class="c1"># html format
</span>
<span class="n">table_pandas</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>All</th> <th>Men</th> <th>Women</th> </tr> </thead> <tbody> <tr> <th>Log Wage</th> <td>3.062748</td> <td>3.099449</td> <td>3.024417</td> </tr> <tr> <th>Sex</th> <td>0.489136</td> <td>0.000000</td> <td>1.000000</td> </tr> <tr> <th>Some High School</th> <td>0.000000</td> <td>0.000000</td> <td>0.000000</td> </tr> <tr> <th>High School Graduate</th> <td>0.000000</td> <td>0.000000</td> <td>0.000000</td> </tr> <tr> <th>Some College</th> <td>0.379438</td> <td>0.405602</td> <td>0.352113</td> </tr> <tr> <th>Gollage Graduate</th> <td>0.433492</td> <td>0.436203</td> <td>0.430661</td> </tr> <tr> <th>Advanced Degree</th> <td>0.187069</td> <td>0.158195</td> <td>0.217226</td> </tr> <tr> <th>Northeast</th> <td>0.229200</td> <td>0.219917</td> <td>0.238895</td> </tr> <tr> <th>Midwest</th> <td>0.249868</td> <td>0.245851</td> <td>0.254063</td> </tr> <tr> <th>South</th> <td>0.298357</td> <td>0.303423</td> <td>0.293066</td> </tr> <tr> <th>West</th> <td>0.222576</td> <td>0.230809</td> <td>0.213976</td> </tr> <tr> <th>Experience</th> <td>12.510201</td> <td>12.202282</td> <td>12.831798</td> </tr> </tbody> </table> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span> <span class="n">table_html</span> <span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;table border="1" class="dataframe"&gt;
  &lt;thead&gt;
    &lt;tr style="text-align: right;"&gt;
      &lt;th&gt;&lt;/th&gt;
      &lt;th&gt;All&lt;/th&gt;
      &lt;th&gt;Men&lt;/th&gt;
      &lt;th&gt;Women&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;th&gt;Log Wage&lt;/th&gt;
      &lt;td&gt;3.062748&lt;/td&gt;
      &lt;td&gt;3.099449&lt;/td&gt;
      &lt;td&gt;3.024417&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Sex&lt;/th&gt;
      &lt;td&gt;0.489136&lt;/td&gt;
      &lt;td&gt;0.000000&lt;/td&gt;
      &lt;td&gt;1.000000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Some High School&lt;/th&gt;
      &lt;td&gt;0.000000&lt;/td&gt;
      &lt;td&gt;0.000000&lt;/td&gt;
      &lt;td&gt;0.000000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;High School Graduate&lt;/th&gt;
      &lt;td&gt;0.000000&lt;/td&gt;
      &lt;td&gt;0.000000&lt;/td&gt;
      &lt;td&gt;0.000000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Some College&lt;/th&gt;
      &lt;td&gt;0.379438&lt;/td&gt;
      &lt;td&gt;0.405602&lt;/td&gt;
      &lt;td&gt;0.352113&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Gollage Graduate&lt;/th&gt;
      &lt;td&gt;0.433492&lt;/td&gt;
      &lt;td&gt;0.436203&lt;/td&gt;
      &lt;td&gt;0.430661&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Advanced Degree&lt;/th&gt;
      &lt;td&gt;0.187069&lt;/td&gt;
      &lt;td&gt;0.158195&lt;/td&gt;
      &lt;td&gt;0.217226&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Northeast&lt;/th&gt;
      &lt;td&gt;0.229200&lt;/td&gt;
      &lt;td&gt;0.219917&lt;/td&gt;
      &lt;td&gt;0.238895&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Midwest&lt;/th&gt;
      &lt;td&gt;0.249868&lt;/td&gt;
      &lt;td&gt;0.245851&lt;/td&gt;
      &lt;td&gt;0.254063&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;South&lt;/th&gt;
      &lt;td&gt;0.298357&lt;/td&gt;
      &lt;td&gt;0.303423&lt;/td&gt;
      &lt;td&gt;0.293066&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;West&lt;/th&gt;
      &lt;td&gt;0.222576&lt;/td&gt;
      &lt;td&gt;0.230809&lt;/td&gt;
      &lt;td&gt;0.213976&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;Experience&lt;/th&gt;
      &lt;td&gt;12.510201&lt;/td&gt;
      &lt;td&gt;12.202282&lt;/td&gt;
      &lt;td&gt;12.831798&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
</code></pre></div></div> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>All</th> <th>Men</th> <th>Women</th> </tr> </thead> <tbody> <tr> <th>Log Wage</th> <td>3.062748</td> <td>3.099449</td> <td>3.024417</td> </tr> <tr> <th>Sex</th> <td>0.489136</td> <td>0.000000</td> <td>1.000000</td> </tr> <tr> <th>Some High School</th> <td>0.000000</td> <td>0.000000</td> <td>0.000000</td> </tr> <tr> <th>High School Graduate</th> <td>0.000000</td> <td>0.000000</td> <td>0.000000</td> </tr> <tr> <th>Some College</th> <td>0.379438</td> <td>0.405602</td> <td>0.352113</td> </tr> <tr> <th>Gollage Graduate</th> <td>0.433492</td> <td>0.436203</td> <td>0.430661</td> </tr> <tr> <th>Advanced Degree</th> <td>0.187069</td> <td>0.158195</td> <td>0.217226</td> </tr> <tr> <th>Northeast</th> <td>0.229200</td> <td>0.219917</td> <td>0.238895</td> </tr> <tr> <th>Midwest</th> <td>0.249868</td> <td>0.245851</td> <td>0.254063</td> </tr> <tr> <th>South</th> <td>0.298357</td> <td>0.303423</td> <td>0.293066</td> </tr> <tr> <th>West</th> <td>0.222576</td> <td>0.230809</td> <td>0.213976</td> </tr> <tr> <th>Experience</th> <td>12.510201</td> <td>12.202282</td> <td>12.831798</td> </tr> </tbody> </table> <p>In particular, the table above shows that the difference in average <em>logwage</em> between men and women is equal to \(0,075\)</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_female</span><span class="p">[</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span><span class="o">-</span> <span class="n">data_male</span><span class="p">[</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-0.07503200512595809
</code></pre></div></div> <p>Thus, the unconditional gender wage gap is about \(7,5\)\% for the group of never married workers (women get paid less on average in our sample). We also observe that never married working women are relatively more educated than working men and have lower working experience.</p> <p>This unconditional (predictive) effect of gender equals the coefficient \(\beta\) in the univariate ols regression of \(Y\) on \(D\):</p> \[\begin{align} \log(Y) &amp;=\beta D + \epsilon. \end{align}\] <p>We verify this by running an ols regression in R.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>
<span class="kn">import</span> <span class="n">statsmodels.formula.api</span> <span class="k">as</span> <span class="n">smf</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nocontrol_model</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span> <span class="n">formula</span> <span class="o">=</span> <span class="sh">'</span><span class="s">lwage ~ sex</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="p">)</span>
<span class="n">nocontrol_est</span> <span class="o">=</span> <span class="n">nocontrol_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">().</span><span class="nf">summary2</span><span class="p">().</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="sh">'</span><span class="s">Coef.</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span>
<span class="n">nocontrol_est</span>
<span class="n">nocontrol_se2</span> <span class="o">=</span> <span class="n">nocontrol_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">().</span><span class="nf">summary2</span><span class="p">().</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="sh">'</span><span class="s">Std.Err.</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span>


<span class="c1"># robust standar erros
</span><span class="n">HCV_coefs</span> <span class="o">=</span> <span class="n">nocontrol_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">().</span><span class="n">cov_HC0</span>
<span class="n">nocontrol_se</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">power</span><span class="p">(</span> <span class="n">HCV_coefs</span><span class="p">.</span><span class="nf">diagonal</span><span class="p">()</span> <span class="p">,</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">nocontrol_se</span>

<span class="c1"># print unconditional effect of gender and the corresponding standard error
</span>
<span class="nf">print</span><span class="p">(</span> <span class="sa">f</span><span class="sh">'</span><span class="s">The estimated gender coefficient is </span><span class="si">{</span><span class="n">nocontrol_est</span><span class="si">}</span><span class="s"> and the corresponding standard error is </span><span class="si">{</span><span class="n">nocontrol_se2</span><span class="si">}</span><span class="sh">'</span> <span class="p">)</span>
<span class="nf">print</span><span class="p">(</span> <span class="sa">f</span><span class="sh">'</span><span class="s">The estimated gender coefficient is </span><span class="si">{</span><span class="n">nocontrol_est</span><span class="si">}</span><span class="s"> and the corresponding robust standard error is </span><span class="si">{</span><span class="n">nocontrol_se</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span> <span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The estimated gender coefficient is -0.07503200512595737 and the corresponding standard error is 0.018373837141543274
The estimated gender coefficient is -0.07503200512595737 and the corresponding robust standard error is 0.01834260093480716 
</code></pre></div></div> <p>Next, we run an ols regression of \(Y\) on \((D,W)\) to control for the effect of covariates summarized in \(W\):</p> \[\begin{align} \log(Y) &amp;=\beta_1 D + \beta_2' W + \epsilon. \end{align}\] <p>Here, we are considering the flexible model from the previous lab. Hence, \(W\) controls for experience, education, region, and occupation and industry indicators plus transformations and two-way interactions.</p> <p>Let us run the ols regression with controls.</p> <h3 id="ols-regression-with-controls">Ols regression with controls</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flex</span> <span class="o">=</span> <span class="sh">'</span><span class="s">lwage ~ sex + (exp1+exp2+exp3+exp4)*(shs+hsg+scl+clg+occ2+ind2+mw+so+we)</span><span class="sh">'</span>

<span class="c1"># The smf api replicates R script when it transform data
</span><span class="n">control_model</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span> <span class="n">formula</span> <span class="o">=</span> <span class="n">flex</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="p">)</span>
<span class="n">control_est</span> <span class="o">=</span> <span class="n">control_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">().</span><span class="nf">summary2</span><span class="p">().</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="sh">'</span><span class="s">Coef.</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="n">control_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">().</span><span class="nf">summary2</span><span class="p">().</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">HCV_coefs</span> <span class="o">=</span> <span class="n">control_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">().</span><span class="n">cov_HC0</span>
<span class="n">control_se</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">power</span><span class="p">(</span> <span class="n">HCV_coefs</span><span class="p">.</span><span class="nf">diagonal</span><span class="p">()</span> <span class="p">,</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">42</span><span class="p">]</span>  <span class="c1"># error standard for sex's coefficients 
</span>
<span class="n">control_se</span>


<span class="nf">print</span><span class="p">(</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Coefficient for OLS with controls </span><span class="si">{</span><span class="n">control_est</span><span class="si">}</span><span class="s"> and the corresponding robust standard error is </span><span class="si">{</span><span class="n">control_se</span><span class="si">}</span><span class="sh">"</span> <span class="p">)</span>

<span class="c1"># confidence interval
</span><span class="n">control_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">().</span><span class="nf">conf_int</span><span class="p">(</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span> <span class="p">).</span><span class="n">loc</span><span class="p">[[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]]</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>               Coef.  Std.Err.          t         P&gt;|t|    [0.025    0.975]
Intercept   3.350844  0.319263  10.495548  2.129350e-25  2.724885  3.976803
occ2[T.10]  0.009382  0.166232   0.056436  9.549973e-01 -0.316539  0.335302
occ2[T.11] -0.574719  0.340497  -1.687883  9.152172e-02 -1.242308  0.092871
occ2[T.12] -0.132992  0.265391  -0.501117  6.163196e-01 -0.653326  0.387342
occ2[T.13] -0.267986  0.251119  -1.067169  2.859685e-01 -0.760338  0.224366
...              ...       ...        ...           ...       ...       ...
exp4:scl    0.024112  0.025867   0.932148  3.513237e-01 -0.026604  0.074829
exp4:clg    0.008900  0.023652   0.376285  7.067278e-01 -0.037473  0.055273
exp4:mw     0.012197  0.022784   0.535335  5.924519e-01 -0.032474  0.056868
exp4:so     0.006360  0.019596   0.324536  7.455511e-01 -0.032061  0.044780
exp4:we     0.033250  0.020541   1.618716  1.055976e-01 -0.007023  0.073524

[246 rows x 6 columns]
Coefficient for OLS with controls -0.06763389814419515 and the corresponding robust standard error is 0.01676536062953687
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>0</th> <th>1</th> </tr> </thead> <tbody> <tr> <th>sex</th> <td>-0.101899</td> <td>-0.033369</td> </tr> </tbody> </table> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">control_model</span> 
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;statsmodels.regression.linear_model.OLS at 0x25aa197e840&gt;
</code></pre></div></div> <p>The estimated regression coefficient \(\beta_1\approx-0.0676\) measures how our linear prediction of wage changes if we set the gender variable \(D\) from 0 to 1, holding the controls \(W\) fixed. We can call this the <em>predictive effect</em> (PE), as it measures the impact of a variable on the prediction we make. Overall, we see that the unconditional wage gap of size \(4\)\% for women increases to about \(7\)\% after controlling for worker characteristics.</p> <p>Next, we are using the Frisch-Waugh-Lovell theorem from the lecture partialling-out the linear effect of the controls via ols.</p> <h3 id="partialling-out-using-ols">Partialling-Out using ols</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models
# model for Y
</span><span class="n">flex_y</span> <span class="o">=</span> <span class="sh">'</span><span class="s">lwage ~  (exp1+exp2+exp3+exp4)*(shs+hsg+scl+clg+occ2+ind2+mw+so+we)</span><span class="sh">'</span>
<span class="c1"># model for D
</span><span class="n">flex_d</span> <span class="o">=</span> <span class="sh">'</span><span class="s">sex ~ (exp1+exp2+exp3+exp4)*(shs+hsg+scl+clg+occ2+ind2+mw+so+we)</span><span class="sh">'</span> 

<span class="c1"># partialling-out the linear effect of W from Y
</span><span class="n">t_Y</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span> <span class="n">formula</span> <span class="o">=</span> <span class="n">flex_y</span> <span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="p">).</span><span class="nf">fit</span><span class="p">().</span><span class="n">resid</span>

<span class="c1"># partialling-out the linear effect of W from D
</span><span class="n">t_D</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span> <span class="n">formula</span> <span class="o">=</span> <span class="n">flex_d</span> <span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="p">).</span><span class="nf">fit</span><span class="p">().</span><span class="n">resid</span>


<span class="n">data_res</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="nf">vstack</span><span class="p">((</span> <span class="n">t_Y</span><span class="p">.</span><span class="n">values</span> <span class="p">,</span> <span class="n">t_D</span><span class="p">.</span><span class="n">values</span> <span class="p">)).</span><span class="n">T</span> <span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="sh">'</span><span class="s">t_Y</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">t_D</span><span class="sh">'</span> <span class="p">]</span> <span class="p">)</span>


<span class="c1"># regression of Y on D after partialling-out the effect of W
</span><span class="n">partial_fit</span> <span class="o">=</span>  <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span> <span class="n">formula</span> <span class="o">=</span> <span class="sh">'</span><span class="s">t_Y ~ t_D</span><span class="sh">'</span> <span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_res</span> <span class="p">).</span><span class="nf">fit</span><span class="p">()</span>
<span class="n">partial_est</span> <span class="o">=</span> <span class="n">partial_fit</span><span class="p">.</span><span class="nf">summary2</span><span class="p">().</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="sh">'</span><span class="s">Coef.</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">t_D</span><span class="sh">'</span><span class="p">]</span>


<span class="c1"># standard error
</span><span class="n">HCV_coefs</span> <span class="o">=</span> <span class="n">partial_fit</span><span class="p">.</span><span class="n">cov_HC0</span>
<span class="n">partial_se</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">power</span><span class="p">(</span> <span class="n">HCV_coefs</span><span class="p">.</span><span class="nf">diagonal</span><span class="p">()</span> <span class="p">,</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Coefficient for D via partialling-out </span><span class="si">{</span><span class="n">partial_est</span><span class="si">}</span><span class="s"> and the corresponding robust standard error is </span><span class="si">{</span><span class="n">partial_se</span><span class="si">}</span><span class="sh">"</span> <span class="p">)</span>

<span class="c1"># confidence interval
</span><span class="n">partial_fit</span><span class="p">.</span><span class="nf">conf_int</span><span class="p">(</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span> <span class="p">).</span><span class="n">loc</span><span class="p">[[</span><span class="sh">'</span><span class="s">t_D</span><span class="sh">'</span><span class="p">]]</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Coefficient for D via partialling-out -0.0676338981441926 and the corresponding robust standard error is 0.0167653606295368
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>0</th> <th>1</th> </tr> </thead> <tbody> <tr> <th>t_D</th> <td>-0.100823</td> <td>-0.034445</td> </tr> </tbody> </table> </div> <p>Again, the estimated coefficient measures the linear predictive effect (PE) of \(D\) on \(Y\) after taking out the linear effect of \(W\) on both of these variables. This coefficient equals the estimated coefficient from the ols regression with controls.</p> <p>We know that the partialling-out approach works well when the dimension of \(W\) is low in relation to the sample size \(n\). When the dimension of \(W\) is relatively high, we need to use variable selection or penalization for regularization purposes.</p> <p>Next, we summarize the results.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>
<span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1"># Ajustar los modelos
</span><span class="n">flex_y</span> <span class="o">=</span> <span class="sh">'</span><span class="s">lwage ~ (exp1+exp2+exp3+exp4)*(scl+clg+ad+occ2+ind2+mw+so+we)</span><span class="sh">'</span>  <span class="c1"># model for Y
</span><span class="n">flex_d</span> <span class="o">=</span> <span class="sh">'</span><span class="s">sex ~ (exp1+exp2+exp3+exp4)*(scl+clg+ad+occ2+ind2+mw+so+we)</span><span class="sh">'</span>  <span class="c1"># model for D
</span>
<span class="c1"># partialling-out the linear effect of W from Y
</span><span class="n">t_Y</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">OLS</span><span class="p">.</span><span class="nf">from_formula</span><span class="p">(</span><span class="n">flex_y</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">).</span><span class="nf">fit</span><span class="p">().</span><span class="n">resid</span>
<span class="c1"># partialling-out the linear effect of W from D
</span><span class="n">t_D</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">OLS</span><span class="p">.</span><span class="nf">from_formula</span><span class="p">(</span><span class="n">flex_d</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">).</span><span class="nf">fit</span><span class="p">().</span><span class="n">resid</span>

<span class="c1"># Ajustar los modelos
</span><span class="n">basic_fit</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">OLS</span><span class="p">.</span><span class="nf">from_formula</span><span class="p">(</span><span class="sh">'</span><span class="s">lwage ~ sex + exp1 + scl + clg +ad+ mw + so + we + occ2+ ind2</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">).</span><span class="nf">fit</span><span class="p">()</span>
<span class="n">control_fit</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">OLS</span><span class="p">.</span><span class="nf">from_formula</span><span class="p">(</span><span class="sh">'</span><span class="s">lwage ~ sex + (exp1+exp2+exp3+exp4)*(scl+clg+ad+occ2+ind2+mw+so+we)</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">).</span><span class="nf">fit</span><span class="p">()</span>
<span class="n">partial_fit</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nc">OLS</span><span class="p">(</span><span class="n">t_Y</span><span class="p">,</span> <span class="n">t_D</span><span class="p">).</span><span class="nf">fit</span><span class="p">()</span>

<span class="n">coefs</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">Basic</span><span class="sh">'</span><span class="p">:</span> <span class="n">basic_fit</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">],</span>
         <span class="sh">'</span><span class="s">Controls</span><span class="sh">'</span><span class="p">:</span> <span class="n">control_fit</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">],</span>
         <span class="sh">'</span><span class="s">Partialling out</span><span class="sh">'</span><span class="p">:</span> <span class="n">partial_fit</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

<span class="n">ses</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">No Controls</span><span class="sh">'</span><span class="p">:</span> <span class="n">basic_fit</span><span class="p">.</span><span class="n">bse</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">],</span>
       <span class="sh">'</span><span class="s">Controls</span><span class="sh">'</span><span class="p">:</span> <span class="n">control_fit</span><span class="p">.</span><span class="n">bse</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">],</span>
       <span class="sh">'</span><span class="s">Partialling out</span><span class="sh">'</span><span class="p">:</span> <span class="n">partial_fit</span><span class="p">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">errorbar</span><span class="p">(</span><span class="n">coefs</span><span class="p">.</span><span class="nf">keys</span><span class="p">(),</span> <span class="n">coefs</span><span class="p">.</span><span class="nf">values</span><span class="p">(),</span> <span class="n">yerr</span><span class="o">=</span><span class="mf">1.96</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">ses</span><span class="p">.</span><span class="nf">values</span><span class="p">())),</span> <span class="n">fmt</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">gray</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Coefficient</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Effect of sex on lwage</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Matias Villalba\AppData\Local\Temp\ipykernel_2932\2694192782.py:21: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  'Partialling out': partial_fit.params[0]}
C:\Users\Matias Villalba\AppData\Local\Temp\ipykernel_2932\2694192782.py:25: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  'Partialling out': partial_fit.bse[0]}
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_48_1-480.webp 480w,/assets/img/p1_output_48_1-800.webp 800w,/assets/img/p1_output_48_1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_48_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The coefficient associated with the gender variable, which indicates the prediction of being female on salary, is initially negative. This suggests that, on average, women have lower salaries than men. However, after adding these controls, such as work experience or educational level, the negative coefficient associated with the gender variable becomes less negative.</p> <p>This change in the gender coefficient could be explained by the fact that the control variables are capturing some of the variability in salaries that was previously incorrectly attributed to gender. This suggests that additional factors, beyond gender, are influencing salaries, and the impact of gender on salaries is less pronounced once these other variables are taken into account. Besides, both FWL and including control variables in the regression model yield coefficient estimates for the variable of interest that reflect its net impact on the dependent variable, once the effects of other explanatory variables have been taken into account.</p> <h3 id="women-and-male-graph-quartic">Women and male graph (quartic)</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>

<span class="c1"># Generar valores de exp4 para predecir las medias de lwage con más puntos
</span><span class="n">exp4_seq</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">].</span><span class="nf">min</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">].</span><span class="nf">max</span><span class="p">(),</span> <span class="mi">500</span><span class="p">)</span>

<span class="c1"># Ajustar el modelo para mujeres
</span><span class="n">loess_model_women</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">nonparametric</span><span class="p">.</span><span class="nf">lowess</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">],</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="c1"># Predecir las medias de lwage utilizando el modelo loess para mujeres
</span><span class="n">lwage_mean_pred_women</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">interp</span><span class="p">(</span><span class="n">exp4_seq</span><span class="p">,</span> <span class="n">loess_model_women</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">loess_model_women</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># Calcular la media de lwage para cada valor único de exp4 solo para mujeres
</span><span class="n">mean_lwage_women</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">].</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>

<span class="c1"># Graficar la relación para mujeres
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">exp4_seq</span><span class="p">,</span> <span class="n">lwage_mean_pred_women</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Loess Smoothing</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">mean_lwage_women</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mean_lwage_women</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Mean lwage (Women only)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Mean lwage</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Mean lwage vs exp4 with Loess Smoothing and Mean lwage vs exp4 (Women only)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylim</span><span class="p">(</span><span class="mf">2.6</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># Ajustar el modelo para hombres
</span><span class="n">loess_model_men</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">nonparametric</span><span class="p">.</span><span class="nf">lowess</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">],</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="c1"># Predecir las medias de lwage utilizando el modelo loess para hombres
</span><span class="n">lwage_mean_pred_men</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">interp</span><span class="p">(</span><span class="n">exp4_seq</span><span class="p">,</span> <span class="n">loess_model_men</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">loess_model_men</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># Calcular la media de lwage para cada valor único de exp4 solo para hombres
</span><span class="n">mean_lwage_men</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">sex</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">].</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">lwage</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>

<span class="c1"># Graficar la relación para hombres
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">exp4_seq</span><span class="p">,</span> <span class="n">lwage_mean_pred_men</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Loess Smoothing</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">mean_lwage_men</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mean_lwage_men</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Mean lwage (Men only)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">exp4</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Mean lwage</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Mean lwage vs exp4 with Loess Smoothing and Mean lwage vs exp4 (Men only)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylim</span><span class="p">(</span><span class="mf">2.6</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_51_0-480.webp 480w,/assets/img/p1_output_51_0-800.webp 800w,/assets/img/p1_output_51_0-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_51_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_51_1-480.webp 480w,/assets/img/p1_output_51_1-800.webp 800w,/assets/img/p1_output_51_1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_51_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="cross-validation-in-lasso-regression---manual-implementation-task"><strong>Cross-Validation in Lasso Regression - Manual Implementation Task</strong></h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Libraries
</span><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pyreadr</span> <span class="k">as</span> <span class="n">rr</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">statsmodels.formula.api</span> <span class="k">as</span> <span class="n">smf</span>

<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span><span class="p">,</span> <span class="n">train_test_split</span>
</code></pre></div></div> <p><strong>1. Data Preparation</strong></p> <p>Load the March Supplement of the U.S. Current Population Survey, year 2015. (wage2015_subsample_inference.Rdata)</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rdata_read</span> <span class="o">=</span> <span class="n">rr</span><span class="p">.</span><span class="nf">read_r</span><span class="p">(</span><span class="sh">"</span><span class="s">../../data/wage2015_subsample_inference.Rdata</span><span class="sh">"</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">rdata_read</span><span class="p">[</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 5150 entries, 10 to 32643
Data columns (total 20 columns):
 #   Column  Non-Null Count  Dtype   
---  ------  --------------  -----   
 0   wage    5150 non-null   float64 
 1   lwage   5150 non-null   float64 
 2   sex     5150 non-null   float64 
 3   shs     5150 non-null   float64 
 4   hsg     5150 non-null   float64 
 5   scl     5150 non-null   float64 
 6   clg     5150 non-null   float64 
 7   ad      5150 non-null   float64 
 8   mw      5150 non-null   float64 
 9   so      5150 non-null   float64 
 10  we      5150 non-null   float64 
 11  ne      5150 non-null   float64 
 12  exp1    5150 non-null   float64 
 13  exp2    5150 non-null   float64 
 14  exp3    5150 non-null   float64 
 15  exp4    5150 non-null   float64 
 16  occ     5150 non-null   category
 17  occ2    5150 non-null   category
 18  ind     5150 non-null   category
 19  ind2    5150 non-null   category
dtypes: category(4), float64(16)
memory usage: 736.3+ KB
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We choose the parameters from flexible model (includes interactions)
</span><span class="n">flex</span> <span class="o">=</span> <span class="sh">'</span><span class="s">lwage ~ sex + shs+hsg+scl+clg+occ2+ind2+mw+so+we + (exp1+exp2+exp3+exp4)*(shs+hsg+scl+clg+occ2+ind2+mw+so+we)</span><span class="sh">'</span>
<span class="n">flex_results_0</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">ols</span><span class="p">(</span><span class="n">flex</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get exogenous variables from flexible model
</span><span class="n">X</span> <span class="o">=</span> <span class="n">flex_results_0</span><span class="p">.</span><span class="n">exog</span>

<span class="c1"># Set endogenous variable
</span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">lwage</span><span class="sh">"</span><span class="p">]</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Separate the data into train and test
</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Se estandariza la data
</span><span class="n">scale</span> <span class="o">=</span> <span class="nc">StandardScaler</span><span class="p">()</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">scale</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">scale</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div></div> <p><strong>2. Define a Range of Alpha (Lambda in our equation) Values</strong></p> <p>We create a list or array of alpha values to iterate over. These will be the different regularization parameters we test. We started testing from 0.1 to 0.5 and found that the MSE in cross-validation was reducing when the alpha value was incrementing. Therefore, we tried with higher values.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alphas</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">45</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</code></pre></div></div> <p><strong>3. Partition the Dataset for k-Fold Cross-Validation</strong></p> <p>We divide the dataset into 5 subsets (or folds). Since we are working with a regression task (predicting the log of wage), we use the K-Fold cross-validator from sklearn. We ensure the data is shuffled by adding ‘shuffle=True’ and set a random state for a reproducible output.</p> <p>Source: https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kf</span> <span class="o">=</span> <span class="nc">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</code></pre></div></div> <p><strong>4. Lasso Regression Implementation</strong></p> <p>Implement a function to fit a Lasso Regression model given a training dataset and an alpha value. The function should return the model’s coefficients and intercept.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">lasso_regression</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Fits a Lasso Regression model

    Args:
        X_train: Training features
        y_train: Target values
        alpha: Regularization parameter (L1 penalty)
        iterations: Number of iterations for gradient descent (default: 100)
        learning_rate: Learning rate for gradient descent (default: 0.01)

    Returns:
        W: Model coefficients (weights)
        b: Model intercept (bias)
    </span><span class="sh">"""</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">.</span><span class="n">shape</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
        <span class="n">dW</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">W</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dW</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">X_train</span><span class="p">[:,</span> <span class="n">j</span><span class="p">].</span><span class="nf">dot</span><span class="p">(</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">Y_pred</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dW</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">X_train</span><span class="p">[:,</span> <span class="n">j</span><span class="p">].</span><span class="nf">dot</span><span class="p">(</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">Y_pred</span><span class="p">)</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
        <span class="n">db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">Y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
        <span class="n">W</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">dW</span>
        <span class="n">b</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">db</span>

    <span class="k">return</span> <span class="n">W</span><span class="p">,</span> <span class="n">b</span>
</code></pre></div></div> <p><strong>5. Cross-Validation Loop and 6. Selection of Optimal Alpha</strong></p> <p>We immplement a for loop to fit the lasso regression. Also, we find the best value of alpha that reduces the average MSE for each fold.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">avg_mse_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">best_alpha</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">min_avg_mse</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="sh">'</span><span class="s">inf</span><span class="sh">'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
    <span class="n">mse_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Initialize an empty list to keep track of the MSE for each fold.
</span>    <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">val_index</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">X_train</span><span class="p">):</span>
        <span class="n">X_train_fold</span><span class="p">,</span> <span class="n">X_val_fold</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[</span><span class="n">val_index</span><span class="p">]</span>
        <span class="n">y_train_fold</span><span class="p">,</span> <span class="n">y_val_fold</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[</span><span class="n">val_index</span><span class="p">]</span>

        <span class="c1"># Train Lasso regression model with the current alpha
</span>        <span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nf">lasso_regression</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">,</span> <span class="n">y_train_fold</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">y_pred_val</span> <span class="o">=</span> <span class="n">X_val_fold</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>

        <span class="c1"># Calculate MSE for this fold
</span>        <span class="n">mse_fold</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">((</span><span class="n">y_val_fold</span> <span class="o">-</span> <span class="n">y_pred_val</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mse_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">mse_fold</span><span class="p">)</span>

    <span class="c1"># Calculate average MSE across all folds
</span>    <span class="n">avg_mse</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">mse_list</span><span class="p">)</span>
    <span class="n">avg_mse_values</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">avg_mse</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Alpha=</span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">, Average MSE: </span><span class="si">{</span><span class="n">avg_mse</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Update the best alpha and minimum average MSE
</span>    <span class="k">if</span> <span class="n">avg_mse</span> <span class="o">&lt;</span> <span class="n">min_avg_mse</span><span class="p">:</span>
        <span class="n">min_avg_mse</span> <span class="o">=</span> <span class="n">avg_mse</span>
        <span class="n">best_alpha</span> <span class="o">=</span> <span class="n">alpha</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Best Alpha: </span><span class="si">{</span><span class="n">best_alpha</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">, Minimum Average MSE: </span><span class="si">{</span><span class="n">min_avg_mse</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Plotting the cross-validated MSE for each alpha value
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">avg_mse_values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Cross-Validated MSE for Different Alpha Values</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Alpha</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Average MSE</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alpha=45.0, Average MSE: 0.41942
Alpha=50.0, Average MSE: 0.41920
Alpha=55.0, Average MSE: 0.41912
Alpha=60.0, Average MSE: 0.41906
Alpha=65.0, Average MSE: 0.41907
Best Alpha: 60.0, Minimum Average MSE: 0.41906
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p1_output_68_1-480.webp 480w,/assets/img/p1_output_68_1-800.webp 800w,/assets/img/p1_output_68_1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p1_output_68_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><strong>7. Model Training and Evaluation</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nf">lasso_regression</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">best_alpha</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lasso_corr</span> <span class="o">=</span> <span class="nf">pearsonr</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lasso_mae</span> <span class="o">=</span> <span class="nf">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">lasso_mse</span> <span class="o">=</span> <span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Correlation: </span><span class="si">{</span><span class="n">lasso_corr</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">MAE: </span><span class="si">{</span><span class="n">lasso_mae</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">MSE: </span><span class="si">{</span><span class="n">lasso_mse</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Correlación: 0.5041
MAE: 0.4756
MSE: 0.3569
</code></pre></div></div> <p><strong>8. Report Results</strong></p> <p>We began by selecting the parameters for a flexible model, one that includes interactions. After selecting the parameters, we found that the alpha value that produced the lowest mean squared error (MSE) in cross-validation was 60. We then trained the model using all the available training data with the best alpha value. Using the fitted betas, we predicted the lwage using the test X vector. The resulting MSE in the test data was 0.3569, which was lower than in the training data (which was 0.41906). This indicates that the model is not overfitting and that we have found a good correlation score (R square) of 50%.</p> </article> <h2>References</h2> <div class="publications"> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Matias Villalba. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script src="/assets/js/shortcut-key.js"></script> </body> </html>