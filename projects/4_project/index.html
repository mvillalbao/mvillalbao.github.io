<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Lab 4 | Matias Villalba </title> <meta name="author" content="Matias Villalba"> <meta name="description" content="Fourth lab assignment for the Causal AI course"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mvillalbao.github.io/projects/4_project/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Matias</span> Villalba </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Lab 4</h1> <p class="post-description">Fourth lab assignment for the Causal AI course</p> </header> <article> <p>The jupiter notebook file is available <a href="https://github.com/alexanderquispe/CausalAI-Course/blob/main/labs/replication_4/lab4_group3_python.ipynb" rel="external nofollow noopener" target="_blank">here</a></p> <h1 id="workgroup-4">Workgroup 4</h1> <p>Authors: Valerie Dube, Erzo Garay, Juan Marcos Guerrero y Matias Villalba</p> <h2 id="bootstraping">Bootstraping</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span> <span class="n">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span><span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
</code></pre></div></div> <h2 id="data-base">Data base</h2> <p>The data is not created randomly; it is extracted from the “penn_jae.dat” database. This database is imported and filtered so that the variable “tg” becomes “t4,” which is a dummy variable identifying those treated with t4 versus individuals in the control group. Additionally, the logarithm of the variable “inuidur1” is created.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Penn</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">../../../data/penn_jae.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">Penn</span><span class="o">=</span> <span class="n">Penn</span><span class="p">[(</span><span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">tg</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">tg</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
<span class="n">Penn</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">Penn</span><span class="p">[</span><span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">tg</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">][[</span><span class="sh">'</span><span class="s">tg</span><span class="sh">'</span><span class="p">]].</span><span class="nf">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">Penn</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">tg</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">t4</span><span class="sh">'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">dep1</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">dep</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">dep2</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">dep</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">log_inuidur1</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">inuidur1</span><span class="sh">'</span><span class="p">])</span>
<span class="n">Penn</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">dep</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Unnamed: 0   abdt   t4  inuidur1  inuidur2  female  black  hispanic  \
0            1  10824  0.0        18        18       0      0         0   
3            4  10824  0.0         1         1       0      0         0   
4            5  10747  0.0        27        27       0      0         0   
11          12  10607  1.0         9         9       0      0         0   
12          13  10831  0.0        27        27       0      0         0   

    othrace  q1  ...  agelt35  agegt54  durable  nondurable  lusd  husd  muld  \
0         0   0  ...        0        0        0           0     0     1     0   
3         0   0  ...        0        0        0           0     1     0     0   
4         0   0  ...        0        0        0           0     1     0     0   
11        0   0  ...        1        0        0           0     0     0     1   
12        0   0  ...        0        1        1           0     1     0     0   

    dep1  dep2  log_inuidur1  
0      0     1      2.890372  
3      0     0      0.000000  
4      0     0      3.295837  
11     0     0      2.197225  
12     1     0      3.295837  

[5 rows x 26 columns]
</code></pre></div></div> <h2 id="bootstrap-function">Bootstrap function</h2> <p>A function is created with the specified linear regression “log(inuidur1)~t4+ (female+black+othrace+dep1+dep2+q2+q3+q4+q5+q6+agelt35+agegt54+durable+lusd+husd),” which outputs information about the estimated coefficients (dep1 and dep2 are dummy variables created from dep; ultimately, it is the same as treating dep as a categorical variable).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_estimates</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="sh">'</span><span class="s">t4</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">female</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">othrace</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dep1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dep2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">q2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">q3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">q4</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">q5</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">q6</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">agelt35</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">agegt54</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">durable</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">lusd</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">husd</span><span class="sh">'</span><span class="p">]]</span>
    <span class="n">X</span><span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> 
    <span class="n">B</span> <span class="o">=</span> <span class="n">Penn</span><span class="p">[</span><span class="sh">'</span><span class="s">log_inuidur1</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">y</span><span class="o">=</span><span class="n">B</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    
    <span class="n">lr</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">()</span>
    <span class="n">lr</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">lr</span><span class="p">.</span><span class="n">intercept_</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">lr</span><span class="p">.</span><span class="n">coef_</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">intercept</span><span class="p">,</span><span class="n">coef</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_indices</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">num_samples</span><span class="p">):</span>
    <span class="k">return</span>  <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">Penn</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">n</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">Penn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">boot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">R</span><span class="p">):</span>
    <span class="n">coeff_1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coeff_2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coeff_3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
        <span class="n">coeff_1</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nf">get_indices</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">coeff_2</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nf">get_indices</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> 
        <span class="n">coeff_3</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nf">get_indices</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">))[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">coeff_1_statistics</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">coeff_1</span><span class="p">),</span><span class="sh">'</span><span class="s">std_error</span><span class="sh">'</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="nf">std</span><span class="p">(</span><span class="n">coeff_1</span><span class="p">)}</span>   
    <span class="n">coeff_2_statistics</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">coeff_2</span><span class="p">),</span><span class="sh">'</span><span class="s">std_error</span><span class="sh">'</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="nf">std</span><span class="p">(</span><span class="n">coeff_2</span><span class="p">)}</span>   
    <span class="n">coeff_3_statistics</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">coeff_3</span><span class="p">),</span><span class="sh">'</span><span class="s">std_error</span><span class="sh">'</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="nf">std</span><span class="p">(</span><span class="n">coeff_3</span><span class="p">)}</span>   
    <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">coeff_1_statistics</span><span class="sh">'</span><span class="p">:</span><span class="n">coeff_1_statistics</span><span class="p">,</span><span class="sh">'</span><span class="s">coeff_2_statistics</span><span class="sh">'</span><span class="p">:</span><span class="n">coeff_2_statistics</span><span class="p">,</span><span class="sh">'</span><span class="s">coeff_3_statistics</span><span class="sh">'</span><span class="p">:</span><span class="n">coeff_3_statistics</span><span class="p">},</span> <span class="n">coeff_1</span><span class="p">,</span> <span class="n">coeff_2</span><span class="p">,</span><span class="n">coeff_3</span> 

</code></pre></div></div> <h2 id="standard-error">Standard error</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="nf">boot</span><span class="p">(</span><span class="n">Penn</span><span class="p">,</span><span class="n">get_estimates</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Result for coefficient term t4 </span><span class="sh">'</span><span class="p">,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_1_statistics</span><span class="sh">'</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Result for coefficient term female</span><span class="sh">'</span><span class="p">,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_2_statistics</span><span class="sh">'</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Result for coefficient term black</span><span class="sh">'</span><span class="p">,</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_3_statistics</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Result for coefficient term t4  {'estimated_value': -0.06988404525587032, 'std_error': 0.03580097798905932}
Result for coefficient term female {'estimated_value': 0.12750195812651027, 'std_error': 0.03530038686565401}
Result for coefficient term black {'estimated_value': -0.2917027856008439, 'std_error': 0.06050929944267628}
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">Variable</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">t4</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">female</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">Estimate</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_1_statistics</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_2_statistics</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_3_statistics</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="sh">"</span><span class="s">Standard Error</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_1_statistics</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">std_error</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_2_statistics</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">std_error</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">coeff_3_statistics</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">std_error</span><span class="sh">'</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Variable  Estimate  Standard Error
0       t4 -0.070467        0.036035
1   female  0.127009        0.035710
2    black -0.293443        0.059621
</code></pre></div></div> <h3 id="t4-distribution">t4 distribution</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">set_theme</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Histogram - t4</span><span class="sh">'</span><span class="s">s coefficient (Density)</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Erzo\AppData\Local\Temp\ipykernel_13076\562490230.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `histplot` (an axes-level function for histograms).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  ax = sns.distplot(results[1], bins=20)





Text(0.5, 1.0, "Histogram - t4's coefficient (Density)")
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p4_output_14_2-480.webp 480w,/assets/img/p4_output_14_2-800.webp 800w,/assets/img/p4_output_14_2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p4_output_14_2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="female-distribution">Female distribution</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">set_theme</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Histogram - female</span><span class="sh">'</span><span class="s">s coefficient (Density)</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Erzo\AppData\Local\Temp\ipykernel_13076\889737210.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `histplot` (an axes-level function for histograms).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  ax = sns.distplot(results[2], bins=20)





Text(0.5, 1.0, "Histogram - female's coefficient (Density)")
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p4_output_16_2-480.webp 480w,/assets/img/p4_output_16_2-800.webp 800w,/assets/img/p4_output_16_2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p4_output_16_2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="black-distribution">Black distribution</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">set_theme</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">distplot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Histogram - black</span><span class="sh">'</span><span class="s">s coefficient (Density)</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Erzo\AppData\Local\Temp\ipykernel_13076\825763745.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `histplot` (an axes-level function for histograms).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  ax = sns.distplot(results[3], bins=20)





Text(0.5, 1.0, "Histogram - black's coefficient (Density)")
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p4_output_18_2-480.webp 480w,/assets/img/p4_output_18_2-800.webp 800w,/assets/img/p4_output_18_2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p4_output_18_2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div> <h2 id="causal-forest">Causal Forest</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Libraries
</span><span class="kn">import</span> <span class="n">statistics</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>
<span class="kn">import</span> <span class="n">statsmodels.formula.api</span> <span class="k">as</span> <span class="n">smf</span>
<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="c1"># Causal forest libraries
</span><span class="kn">from</span> <span class="n">econml.grf</span> <span class="kn">import</span> <span class="n">RegressionForest</span>
<span class="kn">from</span> <span class="n">econml.dml</span> <span class="kn">import</span> <span class="n">CausalForestDML</span>
<span class="kn">from</span> <span class="n">econml.cate_interpreter</span> <span class="kn">import</span> <span class="n">SingleTreeCateInterpreter</span>
</code></pre></div></div> <h3 id="1-preprocessing">1. Preprocessing</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import synthetic data from data folder
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">../../data/synthetic_data.csv</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>schoolid</th> <th>Z</th> <th>Y</th> <th>S3</th> <th>C1</th> <th>C2</th> <th>C3</th> <th>XC</th> <th>X1</th> <th>X2</th> <th>X3</th> <th>X4</th> <th>X5</th> </tr> </thead> <tbody> <tr> <th>0</th> <td>76</td> <td>1</td> <td>0.081602</td> <td>6</td> <td>4</td> <td>2</td> <td>1</td> <td>4</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> </tr> <tr> <th>1</th> <td>76</td> <td>1</td> <td>-0.385869</td> <td>4</td> <td>12</td> <td>2</td> <td>1</td> <td>4</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> </tr> <tr> <th>2</th> <td>76</td> <td>1</td> <td>0.398184</td> <td>6</td> <td>4</td> <td>2</td> <td>0</td> <td>4</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> </tr> <tr> <th>3</th> <td>76</td> <td>1</td> <td>-0.175037</td> <td>6</td> <td>4</td> <td>2</td> <td>0</td> <td>4</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> </tr> <tr> <th>4</th> <td>76</td> <td>1</td> <td>0.884583</td> <td>6</td> <td>4</td> <td>1</td> <td>0</td> <td>4</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> </tr> </tbody> </table> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 10391 entries, 0 to 10390
Data columns (total 13 columns):
 #   Column    Non-Null Count  Dtype  
---  ------    --------------  -----  
 0   schoolid  10391 non-null  int64  
 1   Z         10391 non-null  int64  
 2   Y         10391 non-null  float64
 3   S3        10391 non-null  int64  
 4   C1        10391 non-null  int64  
 5   C2        10391 non-null  int64  
 6   C3        10391 non-null  int64  
 7   XC        10391 non-null  int64  
 8   X1        10391 non-null  float64
 9   X2        10391 non-null  float64
 10  X3        10391 non-null  float64
 11  X4        10391 non-null  float64
 12  X5        10391 non-null  float64
dtypes: float64(6), int64(7)
memory usage: 1.0 MB
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Save school clusters in variable
</span><span class="n">school_id</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">schoolid</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">).</span><span class="n">cat</span><span class="p">.</span><span class="n">codes</span>

<span class="c1"># Create a dummy matrix (one-hot encoding) for school IDs
</span><span class="n">school_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">schoolid</span><span class="sh">'</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="sh">'</span><span class="s">coerce</span><span class="sh">'</span><span class="p">)</span>
<span class="n">school_mat</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nf">add_constant</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nf">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">schoolid</span><span class="sh">'</span><span class="p">],</span> <span class="n">drop_first</span><span class="o">=</span><span class="bp">False</span><span class="p">)).</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:].</span><span class="n">values</span>

<span class="c1"># Calculate the size of each school group
</span><span class="n">school_size</span> <span class="o">=</span> <span class="n">school_mat</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fit treatment (w) OLS
</span><span class="n">formula</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Z ~ </span><span class="sh">'</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> + </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">Z</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">]))</span>
<span class="n">w_lm</span> <span class="o">=</span> <span class="n">smf</span><span class="p">.</span><span class="nf">glm</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">sm</span><span class="p">.</span><span class="n">families</span><span class="p">.</span><span class="nc">Binomial</span><span class="p">()).</span><span class="nf">fit</span><span class="p">()</span>

<span class="c1"># Print summary of the GLM model
</span><span class="nf">print</span><span class="p">(</span><span class="n">w_lm</span><span class="p">.</span><span class="nf">summary</span><span class="p">())</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                 Generalized Linear Model Regression Results                  
==============================================================================
Dep. Variable:                      Z   No. Observations:                10391
Model:                            GLM   Df Residuals:                    10379
Model Family:                Binomial   Df Model:                           11
Link Function:                  Logit   Scale:                          1.0000
Method:                          IRLS   Log-Likelihood:                -6519.5
Date:                Thu, 06 Jun 2024   Deviance:                       13039.
Time:                        20:51:37   Pearson chi2:                 1.04e+04
No. Iterations:                     4   Pseudo R-squ. (CS):           0.007280
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     -1.0758      0.146     -7.348      0.000      -1.363      -0.789
schoolid      -0.0005      0.001     -0.574      0.566      -0.002       0.001
S3             0.1022      0.020      5.233      0.000       0.064       0.141
C1            -0.0023      0.005     -0.431      0.666      -0.013       0.008
C2            -0.0974      0.042     -2.313      0.021      -0.180      -0.015
C3            -0.1378      0.045     -3.050      0.002      -0.226      -0.049
XC             0.0277      0.018      1.568      0.117      -0.007       0.062
X1            -0.0881      0.028     -3.103      0.002      -0.144      -0.032
X2            -0.0004      0.033     -0.011      0.991      -0.066       0.065
X3             0.0337      0.029      1.179      0.239      -0.022       0.090
X4            -0.0201      0.027     -0.738      0.460      -0.074       0.033
X5             0.0082      0.027      0.303      0.762      -0.045       0.062
==============================================================================
</code></pre></div></div> <p>In the previous OLS, we can observe that only the ctudent’s self-reported expectations for success (S3), student gender (C2), student first-generation status (C3), and school-level mean of students’ fixed mindsets (X1) variables are significat</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We define T, Y, and X_raw
</span><span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">]</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">Z</span><span class="sh">'</span><span class="p">]</span>
<span class="n">X_raw</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">schoolid</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Z</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">])</span> <span class="c1"># School ID does not affect pscore
</span><span class="n">W</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create model matrices for categorical variables
</span><span class="n">C1_exp</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">get_dummies</span><span class="p">(</span><span class="n">X_raw</span><span class="p">[</span><span class="sh">'</span><span class="s">C1</span><span class="sh">'</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="sh">'</span><span class="s">C1</span><span class="sh">'</span><span class="p">)</span>
<span class="n">XC_exp</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">get_dummies</span><span class="p">(</span><span class="n">X_raw</span><span class="p">[</span><span class="sh">'</span><span class="s">XC</span><span class="sh">'</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="sh">'</span><span class="s">XC</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Combine these matrices with the rest of the data
</span><span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">X_raw</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">C1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">XC</span><span class="sh">'</span><span class="p">]),</span> <span class="n">C1_exp</span><span class="p">,</span> <span class="n">XC_exp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div> <p>We have a sample of 10,391 children from 76 schools, and we expand the categorical variables, resulting in 28 covariates, \(X_i \in \mathbb{R}^{28}\)</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>S3</th> <th>C2</th> <th>C3</th> <th>X1</th> <th>X2</th> <th>X3</th> <th>X4</th> <th>X5</th> <th>C1_1</th> <th>C1_2</th> <th>...</th> <th>C1_11</th> <th>C1_12</th> <th>C1_13</th> <th>C1_14</th> <th>C1_15</th> <th>XC_0</th> <th>XC_1</th> <th>XC_2</th> <th>XC_3</th> <th>XC_4</th> </tr> </thead> <tbody> <tr> <th>0</th> <td>6</td> <td>2</td> <td>1</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> </tr> <tr> <th>1</th> <td>4</td> <td>2</td> <td>1</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>True</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> </tr> <tr> <th>2</th> <td>6</td> <td>2</td> <td>0</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> </tr> <tr> <th>3</th> <td>6</td> <td>2</td> <td>0</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> </tr> <tr> <th>4</th> <td>6</td> <td>1</td> <td>0</td> <td>0.334544</td> <td>0.648586</td> <td>-1.310927</td> <td>0.224077</td> <td>-0.426757</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> </tr> <tr> <th>...</th> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> </tr> <tr> <th>10386</th> <td>7</td> <td>2</td> <td>1</td> <td>1.185986</td> <td>-1.129889</td> <td>1.009875</td> <td>1.005063</td> <td>-1.174702</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> <td>False</td> </tr> <tr> <th>10387</th> <td>7</td> <td>2</td> <td>1</td> <td>1.185986</td> <td>-1.129889</td> <td>1.009875</td> <td>1.005063</td> <td>-1.174702</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> <td>False</td> </tr> <tr> <th>10388</th> <td>2</td> <td>1</td> <td>1</td> <td>1.185986</td> <td>-1.129889</td> <td>1.009875</td> <td>1.005063</td> <td>-1.174702</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> <td>False</td> </tr> <tr> <th>10389</th> <td>5</td> <td>1</td> <td>1</td> <td>1.185986</td> <td>-1.129889</td> <td>1.009875</td> <td>1.005063</td> <td>-1.174702</td> <td>False</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> <td>False</td> </tr> <tr> <th>10390</th> <td>5</td> <td>2</td> <td>1</td> <td>1.185986</td> <td>-1.129889</td> <td>1.009875</td> <td>1.005063</td> <td>-1.174702</td> <td>True</td> <td>False</td> <td>...</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>False</td> <td>True</td> <td>False</td> </tr> </tbody> </table> <p>10391 rows × 28 columns</p> </div> <p>For each sample \(i\), the authors consider potential outcomes \(Y_i(0)\) and \(Y_i(1)\), representing the outcomes if the \(i\)-th sample had been assigned to control \((W_i=0)\) or treatment \((W_i=1)\), respectively. We assume that we observe \(Y_i = Y_i(W_i)\). The average treatment effect is defined as \(\tau = \mathbb{E} [Y_i(1) - Y_i(0)]\), and the conditional average treatment effect function is \(\tau(x) = \mathbb{E} [Y_i(1) - Y_i(0) \mid X_i = x]\).</p> <h3 id="2-causal-forest-estimation-and-results">2. Causal Forest estimation and results</h3> <h4 id="21-causal-forest">2.1. Causal Forest</h4> <p>When using random forests, the authors aim to perform a non-parametric random effects modeling approach, where each school is presumed to influence the student’s outcome. However, the authors do not impose any assumptions about the distribution of these effects, specifically avoiding the assumption that school effects are Gaussian or additive.</p> <p>The causal forest (CF) method attempts to find neighbourhoods in the covariate space, also known as recursive partitioning. While a random forest is built from decision trees, a causal forest is built from causal trees, where the causal trees learn a low-dimensional representation of treatment effect heterogeneity. To built a CF, we use the post-treatment outcome vector (\(Y\)), the treatment vector (\(T\)), and the 28 parameters matrix (\(X\)).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">forest_model</span> <span class="o">=</span> <span class="nc">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="nc">RegressionForest</span><span class="p">(),</span>
                               <span class="n">model_y</span><span class="o">=</span><span class="nc">RegressionForest</span><span class="p">(),</span>
                               <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
                               <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                               <span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                               <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

<span class="n">tree_model</span> <span class="o">=</span> <span class="n">forest_model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">intrp</span> <span class="o">=</span> <span class="nc">SingleTreeCateInterpreter</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="nf">interpret</span><span class="p">(</span><span class="n">forest_model</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">intrp</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">feature_names</span><span class="o">=</span><span class="n">X</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p4_output_39_0-480.webp 480w,/assets/img/p4_output_39_0-800.webp 800w,/assets/img/p4_output_39_0-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p4_output_39_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>We found that the greater CATE is in the group of students that attendts to a school with a mean fixed mindset level lower than 0.21 (that means, with larger values of growth mindset), and with a percentage of students who are from families whose incomes fall below the federal poverty line greater than -0.75.</p> <h4 id="22-ate">2.2. ATE</h4> <p>The package dml has a built-in function for average treatment effect estimation. First, we estimate the CATE (\(\hat{\tau}\)), where we can see it is around 0.2 and 0.4. Then, we find that the ATE value is around 0.25.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tau_hat</span> <span class="o">=</span> <span class="n">forest_model</span><span class="p">.</span><span class="nf">effect</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span> <span class="c1"># tau(X) estimates
</span><span class="n">statistics</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0.25106325917227695
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Do not use this for assessing heterogeneity. See text above.
</span><span class="n">sns</span><span class="p">.</span><span class="nf">displot</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="sh">"</span><span class="s">density</span><span class="sh">"</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">CATE estimates</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'CATE estimates')
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p4_output_44_1-480.webp 480w,/assets/img/p4_output_44_1-800.webp 800w,/assets/img/p4_output_44_1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p4_output_44_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The causal forest CATE estimates exhibit some variation, from -0.2 to 0.6.</p> <h4 id="23-run-best-linear-predictor-analysis">2.3. Run best linear predictor analysis</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Assuming cf is an instance of an EconML estimator
# and tau_hat is the estimated Conditional Average Treatment Effect (CATE)
</span>
<span class="c1"># Compare regions with high and low estimated CATEs
</span><span class="n">high_effect</span> <span class="o">=</span> <span class="n">tau_hat</span> <span class="o">&gt;</span> <span class="n">np</span><span class="p">.</span><span class="nf">median</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">)</span>

<span class="c1"># Calculate average treatment effect for high and low effect subsets
</span><span class="n">ate_high</span> <span class="o">=</span> <span class="n">tree_model</span><span class="p">.</span><span class="nf">ate_inference</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">high_effect</span><span class="p">])</span>
<span class="n">ate_low</span> <span class="o">=</span> <span class="n">tree_model</span><span class="p">.</span><span class="nf">ate_inference</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">high_effect</span><span class="p">])</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ate_high</span>
</code></pre></div></div> <table class="simpletable"> <caption>Uncertainty of Mean Point Estimate</caption> <tr> <th>mean_point</th> <th>stderr_mean</th> <th>zstat</th> <th>pvalue</th> <th>ci_mean_lower</th> <th>ci_mean_upper</th> </tr> <tr> <td>0.355</td> <td>0.122</td> <td>2.906</td> <td>0.004</td> <td>0.115</td> <td>0.594</td> </tr> </table> <table class="simpletable"> <caption>Distribution of Point Estimate</caption> <tr> <th>std_point</th> <th>pct_point_lower</th> <th>pct_point_upper</th> </tr> <tr> <td>0.08</td> <td>0.257</td> <td>0.558</td> </tr> </table> <table class="simpletable"> <caption>Total Variance of Point Estimate</caption> <tr> <th>stderr_point</th> <th>ci_point_lower</th> <th>ci_point_upper</th> </tr> <tr> <td>0.146</td> <td>0.079</td> <td>0.669</td> </tr> </table> <p><br><br>Note: The stderr_mean is a conservative upper bound.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ate_low</span>
</code></pre></div></div> <table class="simpletable"> <caption>Uncertainty of Mean Point Estimate</caption> <tr> <th>mean_point</th> <th>stderr_mean</th> <th>zstat</th> <th>pvalue</th> <th>ci_mean_lower</th> <th>ci_mean_upper</th> </tr> <tr> <td>0.148</td> <td>0.121</td> <td>1.215</td> <td>0.225</td> <td>-0.091</td> <td>0.386</td> </tr> </table> <table class="simpletable"> <caption>Distribution of Point Estimate</caption> <tr> <th>std_point</th> <th>pct_point_lower</th> <th>pct_point_upper</th> </tr> <tr> <td>0.082</td> <td>-0.043</td> <td>0.249</td> </tr> </table> <table class="simpletable"> <caption>Total Variance of Point Estimate</caption> <tr> <th>stderr_point</th> <th>ci_point_lower</th> <th>ci_point_upper</th> </tr> <tr> <td>0.146</td> <td>-0.162</td> <td>0.426</td> </tr> </table> <p><br><br>Note: The stderr_mean is a conservative upper bound.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate 95% confidence interval for the difference in ATEs
</span><span class="n">difference_in_ate</span> <span class="o">=</span> <span class="mf">0.355</span> <span class="o">-</span> <span class="mf">0.148</span>
<span class="n">ci_width</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mf">0.122</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.121</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">95% CI for difference in ATE: </span><span class="si">{</span><span class="n">difference_in_ate</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s"> +/- </span><span class="si">{</span><span class="n">ci_width</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>95% CI for difference in ATE: 0.207 +/- 0.337
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The fitted causal forest model should provide these values:
</span><span class="n">W_hat</span> <span class="o">=</span> <span class="n">tree_model</span><span class="p">.</span><span class="n">propensity_</span>  <span class="c1"># Estimated treatment probability (cf$W.hat)
</span><span class="n">Y_hat</span> <span class="o">=</span> <span class="n">tree_model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>   <span class="c1"># Predicted outcome (cf$Y.hat)
</span>
<span class="c1"># Calculate dr.score
</span><span class="n">dr_score</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tau_hat</span> <span class="o">+</span> 
    <span class="n">W</span> <span class="o">/</span> <span class="n">W_hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">W_hat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau_hat</span><span class="p">)</span> <span class="o">-</span>
    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">W</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">W_hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span> <span class="o">+</span> <span class="n">W_hat</span> <span class="o">*</span> <span class="n">tau_hat</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Calculate school.score
</span><span class="n">school_score</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">school_mat</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dr_score</span><span class="p">)</span> <span class="o">/</span> <span class="n">school_size</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

Cell In[140], line 2
      1 # Calculate school.score
----&gt; 2 school_score = np.dot(school_mat.T, dr_score) / school_size


NameError: name 'dr_score' is not defined
</code></pre></div></div> <h4 id="24-look-at-school-wise-heterogeneity">2.4. Look at school-wise heterogeneity</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set up plot parameters
</span><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">font.size</span><span class="sh">'</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>  <span class="c1"># Adjust the font size
</span>
<span class="c1"># Create the histogram
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">school_score</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">School Treatment Effect Estimate</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">''</span><span class="p">)</span>

<span class="c1"># Save the plot as a PDF
</span><span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sh">'</span><span class="s">school_hist.pdf</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Close the plot
</span><span class="n">plt</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

Cell In[142], line 6
      4 # Create the histogram
      5 plt.figure(figsize=(8, 6))
----&gt; 6 plt.hist(school_score, bins=30, edgecolor='black')
      7 plt.xlabel('School Treatment Effect Estimate', fontsize=16)
      8 plt.ylabel('Frequency', fontsize=16)


File ~/opt/anaconda3/envs/personal/lib/python3.11/site-packages/matplotlib/pyplot.py:3236, in hist(x, bins, range, density, weights, cumulative, bottom, histtype, align, orientation, rwidth, log, color, label, stacked, data, **kwargs)
   3211 @_copy_docstring_and_deprecators(Axes.hist)
   3212 def hist(
   3213     x: ArrayLike | Sequence[ArrayLike],
   (...)
   3234     BarContainer | Polygon | list[BarContainer | Polygon],
   3235 ]:
-&gt; 3236     return gca().hist(
   3237         x,
   3238         bins=bins,
   3239         range=range,
   3240         density=density,
   3241         weights=weights,
   3242         cumulative=cumulative,
   3243         bottom=bottom,
   3244         histtype=histtype,
   3245         align=align,
   3246         orientation=orientation,
   3247         rwidth=rwidth,
   3248         log=log,
   3249         color=color,
   3250         label=label,
   3251         stacked=stacked,
   3252         **({"data": data} if data is not None else {}),
   3253         **kwargs,
   3254     )


File ~/opt/anaconda3/envs/personal/lib/python3.11/site-packages/matplotlib/__init__.py:1465, in _preprocess_data.&lt;locals&gt;.inner(ax, data, *args, **kwargs)
   1462 @functools.wraps(func)
   1463 def inner(ax, *args, data=None, **kwargs):
   1464     if data is None:
-&gt; 1465         return func(ax, *map(sanitize_sequence, args), **kwargs)
   1467     bound = new_sig.bind(ax, *args, **kwargs)
   1468     auto_label = (bound.arguments.get(label_namer)
   1469                   or bound.kwargs.get(label_namer))


File ~/opt/anaconda3/envs/personal/lib/python3.11/site-packages/matplotlib/axes/_axes.py:6834, in Axes.hist(self, x, bins, range, density, weights, cumulative, bottom, histtype, align, orientation, rwidth, log, color, label, stacked, **kwargs)
   6830 for xi in x:
   6831     if len(xi):
   6832         # python's min/max ignore nan,
   6833         # np.minnan returns nan for all nan input
-&gt; 6834         xmin = min(xmin, np.nanmin(xi))
   6835         xmax = max(xmax, np.nanmax(xi))
   6836 if xmin &lt;= xmax:  # Only happens if we have seen a finite value.


TypeError: '&lt;' not supported between instances of 'ellipsis' and 'float'
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p4_output_53_1-480.webp 480w,/assets/img/p4_output_53_1-800.webp 800w,/assets/img/p4_output_53_1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p4_output_53_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h4 id="25-analysis-ignoring-clusters-how-do-the-results-change">2.5. Analysis ignoring clusters. How do the results change?</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Assuming you have already defined X, Y, W, selected.idx, Y.hat, and W.hat
</span>
<span class="c1"># Create a causal forest model
</span><span class="n">cf_noclust</span> <span class="o">=</span> <span class="nf">tree_model</span><span class="p">(</span><span class="n">tune_parameters</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">)</span>
<span class="n">cf_noclust</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">selected</span><span class="p">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Y_hat</span><span class="o">=</span><span class="n">Y_hat</span><span class="p">,</span> <span class="n">W_hat</span><span class="o">=</span><span class="n">W_hat</span><span class="p">)</span>

<span class="c1"># Calculate the average treatment effect (ATE)
</span><span class="n">ATE_noclust</span> <span class="o">=</span> <span class="n">cf_noclust</span><span class="p">.</span><span class="nf">average_treatment_effect</span><span class="p">()</span>

<span class="c1"># Print the 95% confidence interval for the ATE
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">95% CI for the ATE: </span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="n">ATE_noclust</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s"> +/- </span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="mf">1.96</span> <span class="o">*</span> <span class="n">ATE_noclust</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Test calibration
</span><span class="n">cf_noclust_copy</span> <span class="o">=</span> <span class="n">cf_noclust</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">tau_hat_noclust</span> <span class="o">=</span> <span class="n">cf_noclust_copy</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># Assuming X is the same as in R
</span><span class="n">cf_noclust_copy</span><span class="p">.</span><span class="n">predictions</span> <span class="o">=</span> <span class="n">tau_hat_noclust</span>
<span class="n">cf_noclust_copy</span><span class="p">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">school_id</span>
<span class="n">cf_noclust_copy</span><span class="p">.</span><span class="nf">test_calibration</span><span class="p">()</span>

<span class="c1"># Calculate loss
</span><span class="n">R_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span><span class="p">)</span> <span class="o">-</span> <span class="n">tau_hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W_hat</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<span class="n">R_loss_noclust</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span><span class="p">)</span> <span class="o">-</span> <span class="n">tau_hat_noclust</span> <span class="o">*</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W_hat</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<span class="n">R_loss_crossfold</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_hat</span><span class="p">)</span> <span class="o">-</span> <span class="n">tau_hat_crossfold</span> <span class="o">*</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="n">W_hat</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Print the differences in loss
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Difference in loss (no clustering): </span><span class="si">{</span><span class="n">R_loss_noclust</span> <span class="o">-</span> <span class="n">R_loss</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Difference in loss (crossfold): </span><span class="si">{</span><span class="n">R_loss_crossfold</span> <span class="o">-</span> <span class="n">R_loss</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Summary of ANOVA
# Assuming dr.score and school_id are defined
</span><span class="n">summary_aov</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">dr.score</span><span class="sh">'</span><span class="p">:</span> <span class="n">dr_score</span><span class="p">,</span> <span class="sh">'</span><span class="s">school.id</span><span class="sh">'</span><span class="p">:</span> <span class="n">school_id</span><span class="p">})</span>

</code></pre></div></div> <h4 id="26-analysis-without-fitting-the-propensity-score">2.6. Analysis without fitting the propensity score</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a causal forest model
</span><span class="n">cf_noprop</span> <span class="o">=</span> <span class="nc">CausalForestDML</span><span class="p">(</span><span class="n">tune_parameters</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span> <span class="n">equalize_cluster_weights</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">cf_noprop</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">selected</span><span class="p">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Y_hat</span><span class="o">=</span><span class="n">Y_hat</span><span class="p">,</span> <span class="n">W_hat</span><span class="o">=</span><span class="n">W_hat</span><span class="p">)</span>

<span class="c1"># Calculate the average treatment effect (ATE)
</span><span class="n">ATE_noprop</span> <span class="o">=</span> <span class="n">cf_noprop</span><span class="p">.</span><span class="nf">average_treatment_effect</span><span class="p">()</span>

<span class="c1"># Print the 95% confidence interval for the ATE
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">95% CI for the ATE: </span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="n">ATE_noprop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s"> +/- </span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="mf">1.96</span> <span class="o">*</span> <span class="n">ATE_noprop</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Plot the estimates
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">,</span> <span class="n">tau_hat_noprop</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">tau_hat_noprop</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylim</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">tau_hat_noprop</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Orthogonalized causal forest estimates</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Non-orthogonalized causal forest</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="nf">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">tau_hat_noprop</span><span class="p">)],</span> <span class="p">[</span><span class="nf">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">tau_hat_noprop</span><span class="p">)],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">"</span><span class="s">--</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">gray</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <h4 id="27-the-code-plot-six-plots-in-the-make-some-plots-section-so-explain-what-you-find-there">2.7. The code plot six plots in the Make some plots section, so explain what you find there.</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate the average treatment effect (ATE)
</span><span class="n">ATE_noprop</span> <span class="o">=</span> <span class="n">statistics</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">cf_noprop</span><span class="p">.</span><span class="nf">ate</span><span class="p">())</span>

<span class="c1"># Print the 95% confidence interval for the ATE
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">95% CI for the ATE: </span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="n">ATE_noprop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s"> +/- </span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="mf">1.96</span> <span class="o">*</span> <span class="n">ATE_noprop</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Plot histograms
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Estimated CATE</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Histogram (tau.hat)</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">tau_hat_noprop</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Estimated CATE</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Histogram (tau.hat.noprop)</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">tau_hat_noclust</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Estimated CATE</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Histogram (tau.hat.noclust)</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Boxplots vs. X1 and X2
</span><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">X1</span><span class="sh">"</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">X1</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Estimated CATE</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Boxplot (tau.hat) vs. X1</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># Plot school-wise average CATE estimate
</span><span class="n">school_avg_tauhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">school_mat</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">tau_hat</span><span class="p">)</span> <span class="o">/</span> <span class="n">school_size</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">school_avg_tauhat</span><span class="p">,</span> <span class="n">school_pred</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="nf">min</span><span class="p">(</span><span class="n">school_avg_tauhat</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">school_pred</span><span class="p">)],</span> <span class="p">[</span><span class="nf">min</span><span class="p">(</span><span class="n">school_avg_tauhat</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">school_pred</span><span class="p">)],</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">"</span><span class="s">--</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">gray</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Average CATE estimate in school</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">School-wise forest predictions</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">School-wise Average CATE Estimate vs. Predictions</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <h4 id="28-visualize-school-level-covariates-by-treatment-heterogeneity">2.8. Visualize school-level covariates by treatment heterogeneity</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Standardize school.X
</span><span class="n">school</span><span class="p">.</span><span class="n">X_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">school</span><span class="p">.</span><span class="n">X</span><span class="p">.</span><span class="nf">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">school</span><span class="p">.</span><span class="n">X</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span>

<span class="c1"># Create terciles
</span><span class="n">tercile_bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">pred</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">pred</span><span class="p">,</span> <span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">school</span><span class="p">.</span><span class="n">tercile</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">cut</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">tercile_bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mid</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">])</span>

<span class="c1"># Create a design matrix for terciles
</span><span class="n">school</span><span class="p">.</span><span class="n">tercile_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">get_dummies</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">tercile</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Calculate means
</span><span class="n">school</span><span class="p">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">pinv</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">tercile_mat</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">school</span><span class="p">.</span><span class="n">tercile_mat</span><span class="p">),</span> <span class="n">school</span><span class="p">.</span><span class="n">tercile_mat</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">school</span><span class="p">.</span><span class="n">X_std</span><span class="p">)</span>

<span class="c1"># Calculate MM and create color mapping
</span><span class="n">MM</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">means</span><span class="p">))</span>
<span class="n">school</span><span class="p">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">HC</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="nf">round</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">aa</span><span class="p">))]</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">school</span><span class="p">.</span><span class="n">means</span><span class="p">]</span>

<span class="c1"># Create a DataFrame for plotting
</span><span class="n">DF_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span>
    <span class="sh">'</span><span class="s">tercile</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">repeat</span><span class="p">([</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mid</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">],</span> <span class="mi">9</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="n">school</span><span class="p">.</span><span class="n">means</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span>
    <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">tile</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">X</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Plot the heatmap
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">DF_plot</span><span class="p">.</span><span class="nf">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sh">'</span><span class="s">tercile</span><span class="sh">'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">),</span>
           <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">coolwarm</span><span class="sh">'</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">MM</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">MM</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Mean</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">X</span><span class="p">))),</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">X</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mid</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Feature</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Tercile</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Tercile Plot</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># Calculate mean for XC.3
</span><span class="n">mean_XC3</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="sh">'</span><span class="s">XC.3</span><span class="sh">'</span><span class="p">])</span>
<span class="n">mean_XC3_low_tercile</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">school</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="sh">'</span><span class="s">XC.3</span><span class="sh">'</span><span class="p">][</span><span class="n">school</span><span class="p">.</span><span class="n">tercile</span> <span class="o">==</span> <span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div> <h4 id="29-cate-by-school">2.9. CATE by school</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Order school.pred and then order the indices
</span><span class="nb">ord</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="n">school_pred</span><span class="p">))</span>
<span class="n">school_sort</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">[</span><span class="n">school_id</span><span class="p">]</span>

<span class="c1"># Create a boxplot and save it to a PDF file
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">([</span><span class="n">tau_hat_noclust</span><span class="p">[</span><span class="n">school_sort</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">school_sort</span><span class="p">)],</span>
            <span class="n">positions</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">school_sort</span><span class="p">),</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">boxprops</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">lightblue</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">),</span>
            <span class="n">whiskerprops</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span>
            <span class="n">capprops</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span>
            <span class="n">medianprops</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">meanprops</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">yellow</span><span class="sh">'</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Add points for school mean CATE
</span><span class="n">school_mean_cate</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">tau_hat_noclust</span><span class="p">[</span><span class="n">school_sort</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">school_sort</span><span class="p">)]</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">school_sort</span><span class="p">),</span> <span class="n">school_mean_cate</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">None</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Add points for CATE w/o clustering
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">77</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">school_pred</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">None</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Labels and legend
</span><span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">School</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Estimated CATE</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">school_sort</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">([</span><span class="sh">'</span><span class="s">School mean CATE</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CATE w/o clustering</span><span class="sh">'</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper left</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Save the plot to a PDF file
</span><span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sh">'</span><span class="s">school_boxplot.pdf</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Show plot
</span><span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Matias Villalba. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script src="/assets/js/shortcut-key.js"></script> </body> </html>